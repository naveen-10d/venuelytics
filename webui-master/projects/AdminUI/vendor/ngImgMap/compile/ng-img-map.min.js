!function(e){"use strict";e.module("ngImgMap",[]).factory("ngImgMapCurArea",["$document",function(a){function r(e){e[0]>e[2]&&i(e,0,2),e[1]>e[3]&&i(e,1,3)}function i(e,a,r){var i=e[a];e[a]=e[r],e[r]=i}var n={area:void 0,mouse:[0,0],action:void 0,fn:void 0};return a.find("body").on("mouseup",function(a){e.isDefined(n.area)&&(r(n.area.coords),delete n.area.isDraging,n.area=void 0,n.fn&&e.isFunction(n.fn.dragInit)&&n.fn.dragInit(null,-1))}),n}]).factory("ngImgMapCalculation",["$timeout",function(a){function r(e,a,r){return e>r?r:e<a?a:e}var i=function(e,a){this.dx=0,this.dy=0,this.imgw=e[0],this.imgh=e[1],this.img=[this.imgw,this.imgh],this.canw=Math.min(e[0],a[0]),this.ratio=e[0]&&this.canw?this.canw/e[0]:1};return i.prototype.init=function(e,a,r){var i=this;if(i._getOffset(a,r),0==i.dx&&0==i.dy)return!1;switch(i.curA=a,i.coords=i.curA.area.coords,i.curA.mouse=r,e[0]){case"move":i._move();break;case"resize":i._resize(e[1])}},i.prototype.getDragAction=function(a){var r=a.split(" "),i="move",n=[0,0,0,0];return e.forEach(r,function(a){switch(a){case"bar-remove":i=void 0;break;case"dragline":case"dragdot":i="resize";break;default:var r=new RegExp("ord-([nswe]+)").exec(a)||[];if(r.length){var t=r[1].split("");e.forEach(t,function(e){switch(e){case"w":n[0]=1;break;case"n":n[1]=1;break;case"e":n[2]=1;break;case"s":n[3]=1}})}}}),[i,n]},i.prototype.checkCoords=function(e){e[0]=+e[0]||0,e[1]=+e[1]||0,e[2]=+e[2]||0,e[3]=+e[3]||0;var a=this,i=0,n=0,t=e[0],o=e[1],s=e[2],d=e[3];if(t<0&&(i=-t,t=s=1),s>a.imgw&&(i=a.imgw-s,t=s=1),o<0&&(n=-o,o=d=1),d>a.imgh&&(n=a.imgh-d,o=d=1),(t||o)&&(e[0]+=t*i,e[1]+=o*n,e[2]+=s*i,e[3]+=d*n),Math.abs(e[0]-e[2])>a.imgw||Math.abs(e[1]-e[3])>a.imgh)for(var c=0,g=e.length;c<g;c++)e[c]=r(e[c],0,a.img[c%2]);return e},i.prototype._getOffset=function(e,a){var r=this;r.dx=parseInt((a[0]-e.mouse[0])/r.ratio),r.dy=parseInt((a[1]-e.mouse[1])/r.ratio)},i.prototype._move=function(){var e=this;e._checkEdge(e.coords,[e.coords[0]+e.dx,e.coords[1]+e.dy,e.coords[2]+e.dx,e.coords[3]+e.dy],[1,1,1,1])},i.prototype._resize=function(e){var a=this;a._checkEdge(a.coords,[a.coords[0]+a.dx*e[0],a.coords[1]+a.dy*e[1],a.coords[2]+a.dx*e[2],a.coords[3]+a.dy*e[3]],e)},i.prototype._checkEdge=function(e,a,r){for(var i=this,n=0,t=a.length;n<t;n++)if(a[n]>i.img[n%2]||a[n]<0){a[n]=e[n];var o=(n+2)%4;r[o]&&(a[o]=e[o])}i.curA.area.coords=a},i}]).controller("ngImgMapCtrl",["$scope","ngImgMapCalculation","ngImgMapCurArea","$timeout",function(a,r,i,n){function t(){return o=a.ngImgMapFns,s=a.m=a.ngModel,e.isUndefined(s)?console.warn("ngImgMap need correct ngModel, please check data & format!"):(o&&e.isFunction(o.getImgSize)?d=o.getImgSize(s)||[1e3,100]:(d=[1e3,100],console.warn("ngImgMap need fn to get ImgSize, now use [1000, 100] !")),o&&e.isFunction(o.getCanSize)?c=o.getCanSize(s)||[1e3,100]:(c=[1e3,100],console.warn("ngImgMap need fn to get CanSize, now use [1000, 100] !")),g=new r(d,c),u=g.ratio,s.getCalculation=function(){return g},e.isDefined(s)&&e.forEach(s.maps,function(e){g.checkCoords(e.coords)}),void(a.wrapperStyle=function(){var e=g.img;return{width:e[0]*u+"px",height:e[1]*u+"px","background-image":"url("+s.pic_url+")"}}()))}var o,s,d,c,g,u,v=i,l=null;t(),a.$watch("m.pic_url",function(e,a,r){g&&t()},!0),$(s.containerSelector).bind("resize",function(){n(function(){g&&t()},300)}),a.catchArea=function(a,r,i){a.preventDefault(),a.stopPropagation(),e.isDefined(r)&&r.coords&&(l=r,v.area=r,v.mouse=[a.pageX,a.pageY],v.fn=o,v.action=g.getDragAction(a.target.className),["move","resize"].indexOf(v.action[0])>-1&&(v.area.isDraging=!0,o&&e.isFunction(o.dragInit)&&o.dragInit(r,i)))},a.trackMouse=function(a){if(a.stopPropagation(),l==v.area){var r=v.action;e.isDefined(v.area)&&e.isDefined(r[0])&&v.area.coords&&g.init(r,v,[a.pageX,a.pageY])}},a.removeArea=function(a,r){if(e.isDefined(a[r])){var i=a.splice(r,1);o&&e.isFunction(o.removeArea)&&o.removeArea(i,r)}},a.getAreaStyle=function(e){var a=e.coords||[10,10,50,50];return{width:parseInt(Math.abs(a[0]-a[2])*u)+"px",height:parseInt(Math.abs(a[1]-a[3])*u)+"px",left:parseInt(Math.min(a[0],a[2])*u)+"px",top:parseInt(Math.min(a[1],a[3])*u)+"px"}},a.getCurSize=function(e){var a=Math.abs(e[2]-e[0]),r=Math.abs(e[3]-e[1]);return[a,r].join(" * ")}}]).directive("ngImgMap",["$timeout",function(e){return{restrict:"EA",scope:{ngImgMapFns:"=ngImgMapFns",ngModel:"=ngModel"},templateUrl:"ngImgMap.html",controller:"ngImgMapCtrl"}}]).run(["$templateCache",function(e){var a='<div class="img-map-wrapper" ng-mousemove="trackMouse($event)" ng-style="wrapperStyle">    <div ng-show="area.editMode" ng-repeat="area in m.maps" class="map-area" ng-mousedown="catchArea($event, area, $index)" ng-class="{draging: area.isDraging}" ng-style="getAreaStyle(area)">        <div class="dragbar">            <div class="bar-title">{{$index+1}}</div>            <div class="bar-remove" ng-click="removeArea(m.maps, $index)">&times;</div>            <div class="bar-size">{{getCurSize(area.coords)}}</div>            <div class="bar-coords">{{area.coords}}</div>        </div>        <div class="ord-n dragline"></div>        <div class="ord-e dragline"></div>        <div class="ord-s dragline"></div>        <div class="ord-w dragline"></div>        <div class="ord-n dragdot"></div>        <div class="ord-e dragdot"></div>        <div class="ord-s dragdot"></div>        <div class="ord-w dragdot"></div>        <div class="ord-nw dragdot"></div>        <div class="ord-ne dragdot"></div>        <div class="ord-sw dragdot"></div>        <div class="ord-se dragdot"></div>    </div></div>';e.put("ngImgMap.html",a)}])}(angular);